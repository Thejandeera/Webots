from controller import Robot

def run_robot(robot):
    """ Wall-following robot with dynamic color detection """
    
    # Get the time step of the current world
    timestep = int(robot.getBasicTimeStep())
    max_speed = 6.28
    
    # Enable motors
    left_motor = robot.getMotor('left wheel motor')
    right_motor = robot.getMotor('right wheel motor')
    
    left_motor.setPosition(float('inf'))
    left_motor.setVelocity(0.0)
    
    right_motor.setPosition(float('inf'))
    right_motor.setVelocity(0.0)
    
    # Enable proximity sensors
    prox_sensors = []
    for ind in range(8):
        sensor_name = 'ps' + str(ind)
        prox_sensors.append(robot.getDistanceSensor(sensor_name))
        prox_sensors[ind].enable(timestep)
    
    # Enable the camera
    camera = robot.getDevice("camera")
    camera.enable(timestep)
    
    def detect_color():
        """Detect the color of the wall using the camera."""
        image = camera.getImage()
        width = camera.getWidth()
        height = camera.getHeight()
        red = camera.imageGetRed(image, width, height // 2, width // 2)
        green = camera.imageGetGreen(image, width, height // 2, width // 2)
        blue = camera.imageGetBlue(image, width, height // 2, width // 2)
        
        # Map RGB values to colors
        if red > 200 and green < 100 and blue < 100:
            return "Red"
        elif red > 200 and green > 200 and blue < 100:
            return "Yellow"
        elif red > 200 and green < 150 and blue > 150:
            return "Pink"
        elif red > 100 and green < 100 and blue < 50:
            return "Brown"
        elif red < 100 and green > 200 and blue < 100:
            return "Green"
        else:
            return "Unknown"

    def turn_left():
        """Turn the robot left."""
        left_motor.setVelocity(-max_speed / 2)
        right_motor.setVelocity(max_speed / 2)
        robot.step(int(1000 / timestep))  # Turn for a short duration
        left_motor.setVelocity(0)
        right_motor.setVelocity(0)

    def turn_right():
        """Turn the robot right."""
        left_motor.setVelocity(max_speed / 2)
        right_motor.setVelocity(-max_speed / 2)
        robot.step(int(1000 / timestep))  # Turn for a short duration
        left_motor.setVelocity(0)
        right_motor.setVelocity(0)

    def stop_robot():
        """Stop the robot."""
        left_motor.setVelocity(0)
        right_motor.setVelocity(0)
        print("Robot stopped.")

    # Main loop
    while robot.step(timestep) != -1:
        # Read the sensors
        left_wall = prox_sensors[5].getValue() > 80
        front_wall = prox_sensors[7].getValue() > 80
        right_wall = prox_sensors[2].getValue() > 80  # Detect right wall

        # Default motor speeds
        left_speed = max_speed
        right_speed = max_speed

        # Detect and respond to colors
        if left_wall:
            print("Detecting color on the left wall.")
            turn_left()  # Turn to face the left wall
            detected_color = detect_color()
            print(f"Detected Color on Left: {detected_color}")
            if detected_color == "Green":
                stop_robot()
                break
            turn_right()  # Return to original direction

        if right_wall:
            print("Detecting color on the right wall.")
            turn_right()  # Turn to face the right wall
            detected_color = detect_color()
            print(f"Detected Color on Right: {detected_color}")
            if detected_color == "Green":
                stop_robot()
                break
            turn_left()  # Return to original direction

        # Wall-following logic
        if front_wall:
            print("Turn right in place")
            left_speed = max_speed
            right_speed = -max_speed
        else:
            if left_wall:
                print("Drive forward")
                left_speed = max_speed
                right_speed = max_speed
            elif right_wall:
                print("Drive forward along right wall")
                left_speed = max_speed
                right_speed = max_speed / 2
            else:
                print("Searching for wall")
                left_speed = max_speed / 2
                right_speed = max_speed

        # Set motor velocities
        left_motor.setVelocity(left_speed)
        right_motor.setVelocity(right_speed)

if __name__ == "__main__":
    # Create the Robot instance
    my_robot = Robot()
    run_robot(my_robot)
