from controller import Robot

def run_robot(robot):
    """ Wall-following robot with color detection for small patches of color """
    
    # Get the time step of the current world
    timestep = int(robot.getBasicTimeStep())
    max_speed = 6.28
    
    # Enable motors
    left_motor = robot.getDevice('left wheel motor')
    right_motor = robot.getDevice('right wheel motor')
    
    left_motor.setPosition(float('inf'))
    left_motor.setVelocity(0.0)
    
    right_motor.setPosition(float('inf'))
    right_motor.setVelocity(0.0)
    
    # Enable proximity sensors
    prox_sensors = []
    for ind in range(8):
        sensor_name = 'ps' + str(ind)
        prox_sensors.append(robot.getDevice(sensor_name))
        prox_sensors[ind].enable(timestep)
    
    # Enable the camera
    camera = robot.getDevice("camera")
    camera.enable(timestep)
    
    def detect_color():
        """Detect any prominent color in the image using pixel thresholds."""
        image = camera.getImage()
        if image is None:
            print("Camera image is not available")
            return "Unknown"
        
        width = camera.getWidth()
        height = camera.getHeight()
        # print(f"Camera dimensions: Width = {width}, Height = {height}")  # Debugging info

        # Initialize counters for each color
        red_count = 0
        yellow_count = 0
        pink_count = 0
        brown_count = 0
        green_count = 0
        total_pixels = width * height  # Total number of pixels in the image

        # Pixel threshold to detect a color (e.g., at least 5% of total pixels)
        pixel_threshold = 0.02 * total_pixels

        # Iterate over all pixels
        for y in range(height):
            for x in range(width):
                pixel_index = 4 * (y * width + x)
                red = image[pixel_index + 2]  # Red component
                green = image[pixel_index + 1]  # Green component
                blue = image[pixel_index + 0]  # Blue component

                # Check pixel against color thresholds
                if red > 200 and green < 100 and blue < 100:
                    red_count += 1
                elif red > 200 and green > 200 and blue < 100:
                    yellow_count += 1
                elif red > 200 and green < 150 and blue > 150:
                    pink_count += 1
                elif red > 100 and green < 100 and blue < 50:
                    brown_count += 1
                elif red < 100 and green > 200 and blue < 100:
                    green_count += 1

        # Check if any color exceeds the pixel threshold
        if red_count > pixel_threshold:
            return "Red"
        elif yellow_count > pixel_threshold:
            return "Yellow"
        elif pink_count > pixel_threshold:
            return "Pink"
        elif brown_count > pixel_threshold:
            return "Brown"
        elif green_count > pixel_threshold:
            return "Green"
        else:
            return "Unknown"

    # Main loop
    while robot.step(timestep) != -1:
        # Read the sensors
        left_distance = prox_sensors[5].getValue()
        right_distance = prox_sensors[2].getValue()
        left_wall = left_distance > 80
        right_wall = right_distance > 80
        left_corner = prox_sensors[6].getValue() > 80
        front_wall = prox_sensors[7].getValue() > 80
        
        # Default motor speeds
        left_speed = max_speed
        right_speed = max_speed

        # Logic for wall following and centering between walls
        if front_wall:
            print("Turn right in place")
            left_speed = max_speed
            right_speed = -max_speed
        else:
            if left_wall and right_wall:
                print("Centering between two walls")
                balance_factor = (left_distance - right_distance) / 10  # Normalize difference
                left_speed = max_speed - balance_factor
                right_speed = max_speed + balance_factor
            elif left_wall:
                print("Drive forward along left wall")
                left_speed = max_speed
                right_speed = max_speed
            elif right_wall:
                print("Drive forward along right wall")
                left_speed = max_speed
                right_speed = max_speed / 2
            else:
                print("Searching for wall")
                left_speed = max_speed / 8
                right_speed = max_speed
            if left_corner:
                print("Came too close, turn right")
                left_speed = max_speed
                right_speed = max_speed / 8

        # Continuous color monitoring
        detected_color = detect_color()
        if detected_color != "Unknown":
            print(f"Detected Color: {detected_color}")

        # Set motor velocities
        left_motor.setVelocity(left_speed)
        right_motor.setVelocity(right_speed)

if __name__ == "__main__":
    # Create the Robot instance
    my_robot = Robot()
    run_robot(my_robot)
